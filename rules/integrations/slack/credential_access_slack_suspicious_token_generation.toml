[metadata]
creation_date = "2025/11/15"
integration = ["slack"]
maturity = "production"
updated_date = "2025/11/15"

[rule]
author = ["Elastic"]
description = """
Detects when Slack identifies suspicious API token generation or OAuth token creation activities that may indicate
attempts to establish persistent API access for data exfiltration or automated attacks. Unusual token generation
patterns can signal compromised accounts creating backdoor access or malicious applications harvesting credentials.
"""
false_positives = [
    "Legitimate API integration development and testing",
    "Authorized automation tools or scripts requiring API access",
    "CI/CD pipeline configurations generating service tokens",
    "Approved bot accounts or service accounts being provisioned"
]
from = "now-60m"
index = ["filebeat-*", "logs-slack*"]
interval = "10m"
language = "kuery"
license = "Elastic License v2"
name = "Slack Suspicious API Token Generation Detected"
note = """## Triage and analysis

### Investigating Slack Suspicious Token Generation

API tokens and OAuth credentials provide programmatic access to Slack workspaces, enabling automation but also creating
significant security risks when compromised. Suspicious token generation patterns may indicate attackers establishing
persistent access mechanisms, credential harvesting operations, or preparation for automated data exfiltration.

Common malicious token generation scenarios include:
- Compromised accounts generating tokens for persistent backdoor access
- Malicious applications harvesting OAuth tokens from users
- Insider threats creating tokens for unauthorized data access
- Automated credential harvesting tools collecting API access
- Attackers creating service tokens to evade user-based monitoring
- Token generation for command and control (C2) infrastructure

#### Possible investigation steps

- Identify the account generating tokens via `slack.audit.actor.user.id` and `slack.audit.actor.user.email`.
- Review the `slack.audit.context.session_id` to understand the token generation context.
- Determine the type and scope of tokens being generated (user tokens, bot tokens, etc.).
- Review the OAuth scopes and permissions granted to generated tokens.
- Check the timing and velocity of token generation activities.
- Investigate what applications or services are associated with the tokens.
- Review if tokens were generated for legitimate integrations or unknown apps.
- Check for signs of account compromise (unusual login locations, sessions).
- Examine subsequent API activity using the generated tokens.
- Correlate with other suspicious activities from the same account.
- Review recent authentication failures or credential access attempts.
- Investigate if multiple tokens were generated in rapid succession.

### False positive analysis

- Developers creating tokens for legitimate API integration testing.
- Automated provisioning systems generating service account tokens.
- CI/CD pipelines requiring API access for deployments or testing.
- Authorized bot accounts or automation tools being configured.
- IT administrators creating tokens for approved integrations.

### Response and remediation

- **Immediate Actions:**
  - Immediately revoke all suspicious or unauthorized API tokens.
  - Suspend the account that generated suspicious tokens pending investigation.
  - Review and revoke any active sessions for the affected account.
  - Document all generated tokens and their granted permissions.
  - Monitor for API activity using the suspicious tokens.

- **Investigation Actions:**
  - Audit all API activity performed using the generated tokens.
  - Identify what data or resources were accessed via suspicious tokens.
  - Determine if tokens were used for data exfiltration or reconnaissance.
  - Review network logs for connections to suspicious endpoints.
  - Check for data transfers or unusual API call patterns.
  - Investigate the account for signs of compromise or malicious intent.
  - Interview the account owner to determine if token generation was authorized.

- **Containment Actions:**
  - Implement token generation approval workflows for sensitive scopes.
  - Restrict API token creation permissions to authorized users.
  - Enable additional logging and alerting for token generation.
  - Deploy monitoring for unusual API activity patterns.
  - Implement rate limiting on token generation.
  - Review and minimize OAuth scope grants for applications.
  - Consider implementing token rotation policies.

- **Recovery and Prevention:**
  - Audit all existing API tokens and revoke unnecessary ones.
  - Implement least-privilege principles for API token scopes.
  - Deploy behavioral analytics to detect unusual token usage.
  - Regular audits of token generation and API access patterns.
  - Implement short-lived tokens with automatic rotation where possible.
  - Provide security awareness training on API security best practices.
  - Consider implementing API gateway with enhanced monitoring.
  - Enable MFA for accounts with token generation privileges.
  - Regular review of application permissions and OAuth grants.

- **Legal and Compliance Actions:**
  - Notify legal team if credential theft or unauthorized access occurred.
  - Document the incident for compliance and audit purposes.
  - Assess if data was accessed or exfiltrated using suspicious tokens.
  - Comply with breach notification requirements if applicable.
  - Report to appropriate authorities if criminal activity is confirmed.

## Setup

The Slack Fleet integration, Filebeat module, or similarly structured data is required. Slack's audit log anomaly
detection must be configured to identify suspicious token generation patterns. The rule monitors for 'unexpected_token_generation'
in the `slack.audit.details.reason` field. API token management policies and approval workflows should be implemented
to complement this detection. Consider implementing token rotation and least-privilege OAuth scopes."""
references = [
    "https://docs.slack.dev/reference/audit-logs-api/anomalous-events-reference/",
    "https://attack.mitre.org/techniques/T1528/",
    "https://attack.mitre.org/techniques/T1550/"
]
risk_score = 73
rule_id = "e9f0a1b2-3c4d-5e6f-7a8b-9c0d1e2f3a4b"
severity = "high"
tags = [
    "Data Source: Slack",
    "Use Case: Threat Detection",
    "Tactic: Credential Access",
    "Tactic: Persistence",
    "Resources: Investigation Guide"
]
timestamp_override = "event.ingested"
type = "query"

query = '''
event.dataset:slack.audit and event.action:anomaly and slack.audit.details.reason:unexpected_token_generation
'''


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1528"
name = "Steal Application Access Token"
reference = "https://attack.mitre.org/techniques/T1528/"

[rule.threat.tactic]
id = "TA0006"
name = "Credential Access"
reference = "https://attack.mitre.org/tactics/TA0006/"

[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1550"
name = "Use Alternate Authentication Material"
reference = "https://attack.mitre.org/techniques/T1550/"

[rule.threat.tactic]
id = "TA0005"
name = "Defense Evasion"
reference = "https://attack.mitre.org/tactics/TA0005/"

[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1098"
name = "Account Manipulation"
reference = "https://attack.mitre.org/techniques/T1098/"

[rule.threat.tactic]
id = "TA0003"
name = "Persistence"
reference = "https://attack.mitre.org/tactics/TA0003/"
