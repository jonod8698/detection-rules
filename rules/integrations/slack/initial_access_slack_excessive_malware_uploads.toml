[metadata]
creation_date = "2025/10/31"
integration = ["slack"]
maturity = "production"
updated_date = "2025/10/31"

[rule]
author = ["Elastic"]
description = """
Detects when Slack identifies that a user has uploaded an excessive number of files containing malware. This critical
security event indicates either a compromised account being used to distribute malware, an insider threat, or a targeted
attack attempting to infect other users within the organization's Slack workspace.
"""
false_positives = [
    "Security teams uploading malware samples for analysis in designated channels",
    "Penetration testers sharing proof-of-concept exploits with authorization",
    "False positives from overly aggressive antivirus signatures",
    "Legitimate files incorrectly classified as malware"
]
from = "now-60m"
index = ["filebeat-*", "logs-slack*"]
interval = "5m"
language = "kuery"
license = "Elastic License v2"
name = "Slack Excessive Malware Uploads Detected"
note = """## Triage and analysis

### Investigating Slack Excessive Malware Uploads

The detection of excessive malware uploads is a critical security incident requiring immediate response. This anomaly
indicates that multiple files identified as malicious have been uploaded to Slack, which could represent:
- A compromised account being used to distribute malware to other users
- An active ransomware or malware campaign targeting the organization
- Insider threat attempting to sabotage systems or steal data
- Supply chain attack attempting to compromise downstream partners
- Weaponized documents targeting specific individuals (spear phishing)

#### Possible investigation steps

- **CRITICAL**: Immediately identify the affected user via `slack.audit.actor.user.id` and `slack.audit.actor.user.email`.
- Identify all files uploaded and their distribution (channels, direct messages, users who downloaded them).
- Determine the malware types detected (trojan, ransomware, infostealers, etc.).
- Check the `slack.audit.context.session_id` to understand the full scope of the session.
- Identify all users who may have downloaded or accessed the malicious files.
- Review the upload timestamps to determine the attack timeline and velocity.
- Check if the malware was targeted at specific users or broadcast widely.
- Examine the source of the files - were they created by the user or obtained elsewhere?
- Look for correlation with email phishing campaigns or other attack vectors.
- Review endpoint detection alerts for any users who downloaded the files.
- Check if the uploader's device shows signs of compromise.
- Investigate whether this is part of a larger campaign affecting multiple organizations.

### False positive analysis

- Security teams legitimately sharing malware samples for research or training.
- Incident response teams uploading infected files for collaborative analysis.
- Penetration testing activities with proper authorization and controls.
- Antivirus false positives on legitimate macro-enabled documents or scripts.
- Development tools or scripts incorrectly flagged as potentially unwanted programs (PUPs).

### Response and remediation

- **CRITICAL - Immediate Actions:**
  - Immediately disable the uploading user's account to prevent further uploads.
  - Delete all identified malware files from Slack immediately.
  - Identify and notify all users who downloaded the malicious files.
  - Isolate any endpoints that downloaded the malware from the network.
  - Initiate incident response procedures for potential malware outbreak.
  - Preserve evidence for forensic analysis and potential legal action.

- **Containment Actions:**
  - Run full antivirus scans on all potentially affected endpoints.
  - Block the malware hashes at all security control points.
  - Temporarily disable file uploads in affected channels if necessary.
  - Implement emergency DLP rules to prevent malware distribution.
  - Check email and other communication channels for similar malware.
  - Review and block any C2 infrastructure identified in the malware.

- **Investigation and Recovery:**
  - Conduct forensic analysis on the uploader's device to determine infection source.
  - Analyze the malware to understand its capabilities and potential impact.
  - Review all actions taken by the compromised account.
  - Check for data exfiltration or lateral movement indicators.
  - Restore any systems affected by the malware from clean backups.
  - Document the incident timeline and attack chain.

- **Post-Incident Actions:**
  - Conduct a lessons learned review with all stakeholders.
  - Update security awareness training to include this attack scenario.
  - Implement enhanced file scanning for Slack uploads.
  - Review and strengthen malware detection capabilities.
  - Consider implementing sandboxing for file uploads.
  - Update incident response playbooks based on findings.
  - Share threat intelligence with relevant security communities.

## Setup

The Slack Fleet integration, Filebeat module, or similarly structured data is required. Slack must have malware
scanning enabled for file uploads, and audit logging must capture malware detection events. The rule monitors for
'excessive_malware_uploads' in the `slack.audit.details.reason` field. Ensure integration with antivirus/EDR
solutions for comprehensive malware detection and response capabilities."""
references = [
    "https://docs.slack.dev/reference/audit-logs-api/anomalous-events-reference/",
    "https://attack.mitre.org/techniques/T1566/001/",
    "https://attack.mitre.org/techniques/T1105/",
    "https://attack.mitre.org/techniques/T1486/"
]
risk_score = 99
rule_id = "2d145227-9372-4981-b680-9ff341d6d8c8"
severity = "critical"
tags = [
    "Data Source: Slack",
    "Use Case: Malware Detection",
    "Tactic: Impact",
    "Tactic: Initial Access",
    "Resources: Investigation Guide"
]
timestamp_override = "event.ingested"
type = "query"

query = '''
event.dataset:slack.audit and event.action:anomaly and slack.audit.details.reason:excessive_malware_uploads
'''


[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1566"
name = "Phishing"
reference = "https://attack.mitre.org/techniques/T1566/"
[[rule.threat.technique.subtechnique]]
id = "T1566.001"
name = "Spearphishing Attachment"
reference = "https://attack.mitre.org/techniques/T1566/001/"

[rule.threat.tactic]
id = "TA0001"
name = "Initial Access"
reference = "https://attack.mitre.org/tactics/TA0001/"

[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1486"
name = "Data Encrypted for Impact"
reference = "https://attack.mitre.org/techniques/T1486/"

[rule.threat.tactic]
id = "TA0040"
name = "Impact"
reference = "https://attack.mitre.org/tactics/TA0040/"

[[rule.threat]]
framework = "MITRE ATT&CK"
[[rule.threat.technique]]
id = "T1105"
name = "Ingress Tool Transfer"
reference = "https://attack.mitre.org/techniques/T1105/"

[rule.threat.tactic]
id = "TA0011"
name = "Command and Control"
reference = "https://attack.mitre.org/tactics/TA0011/"